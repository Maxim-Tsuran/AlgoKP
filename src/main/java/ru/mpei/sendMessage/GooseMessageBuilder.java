package ru.mpei.sendMessage;

import ru.mpei.xml.GooseConfig;
import ru.mpei.xml.NetworkConfig;

import java.nio.ByteBuffer;

public class GooseMessageBuilder {

    public byte[] build(GooseConfig config) {
        NetworkConfig net = config.getNetwork();

        byte[] dstMac = parseMac(net.getMacAddressDst());
        byte[] srcMac = parseMac(net.getMacAddressSrc());
        short etherType = (short) Integer.parseInt(net.getEtherType(), 16);

        // Заготовка Ethernet II кадра
        ByteBuffer buffer = ByteBuffer.allocate(1500); // MTU Ethernet

        // Ethernet Header: Destination MAC (6), Source MAC (6), EtherType (2)
        buffer.put(dstMac);
        buffer.put(srcMac);
        buffer.putShort(etherType);

        // Placeholder for GOOSE payload
        byte[] dummyGooseData = new byte[] {
                0x00, 0x01, 0x00, (byte) 0x90, 0x00, 0x00, 0x00, 0x00,
                0x61, (byte) 0x81, (byte) 0x85, (byte) 0x80, 0x1a, 0x47, 0x45, 0x44,
                0x65, 0x76, 0x69, 0x63, 0x65, 0x46, 0x36, 0x35,
                0x30, 0x2f, 0x4c, 0x4c, 0x4e, 0x30, 0x24, 0x47,
                0x4f, 0x24, 0x67, 0x63, 0x62, 0x30, 0x31, (byte) 0x81,
                0x02, 0x03, (byte) 0xe8, (byte) 0x82, 0x18, 0x47, 0x45, 0x44,
                0x65, 0x76, 0x69, 0x63, 0x65, 0x46, 0x36, 0x35,
                0x30, 0x2f, 0x4c, 0x4c, 0x4e, 0x30, 0x24, 0x47,
                0x4f, 0x4f, 0x53, 0x45, 0x31, (byte) 0x83, 0x0b, 0x46,
                0x36, 0x35, 0x30, 0x5f, 0x47, 0x4f, 0x4f, 0x53,
                0x45, 0x31, (byte) 0x84, 0x08, 0x38, 0x6e, (byte) 0xbc, 0x41,
                (byte) 0xed, 0x76, (byte) 0xec, 0x0a, (byte) 0x85, 0x01, 0x01, (byte) 0x86,
                0x01, 0x02, (byte) 0x87, 0x01, 0x00, (byte) 0x88, 0x01, 0x01,
                (byte) 0x89, 0x01, 0x00, (byte) 0x8a, 0x01, 0x08, (byte) 0xab, 0x20,
                (byte) 0x83, 0x01, 0x00, (byte) 0x84, 0x03, 0x03, 0x00, 0x00,
                (byte) 0x83, 0x01, 0x00, (byte) 0x84, 0x03, 0x03, 0x00, 0x00,
                (byte) 0x83, 0x01, 0x00, (byte) 0x84, 0x03, 0x03, 0x00, 0x00,
                (byte) 0x83, 0x01, 0x00, (byte) 0x84, 0x03, 0x03, 0x00, 0x00
        }; // Заглушка (BER тип 0x61)
        buffer.put(dummyGooseData);

        byte[] gooseMessage = new byte[buffer.position()];
        buffer.flip();
        buffer.get(gooseMessage);

        return gooseMessage;
    }

    private byte[] parseMac(String mac) {
        String[] hex = mac.split(":");
        byte[] bytes = new byte[6];
        for (int i = 0; i < 6; i++) {
            bytes[i] = (byte) Integer.parseInt(hex[i], 16);
        }
        return bytes;
    }
}
